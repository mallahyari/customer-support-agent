# Quick Start Guide

## Tech Stack
- **Backend:** FastAPI + SQLAlchemy (async) + SQLite
- **Vector DB:** ChromaDB (embedded mode, file-based)
- **AI:** OpenAI API
  - Embeddings: `text-embedding-3-small`
  - Chat: `gpt-4o-mini`
- **Frontend (Dashboard):** React + Vite + TypeScript + Tailwind CSS + Shadcn/UI
- **Widget:** React (compiled to single `widget.js` via Vite library mode)
- **Auth:** Session-based (bcrypt passwords, session tokens)

---

## Database Schema (SQLite)

### Table: `bots`
```sql
CREATE TABLE bots (
    id TEXT PRIMARY KEY,              -- UUID
    name TEXT NOT NULL,
    welcome_message TEXT,
    avatar_url TEXT,                  -- Path to uploaded image (nullable)
    accent_color TEXT DEFAULT '#3B82F6',
    position TEXT DEFAULT 'bottom-right',  -- 'bottom-right' | 'bottom-left' | 'bottom-center'
    show_button_text BOOLEAN DEFAULT 0,
    button_text TEXT DEFAULT 'Chat with us',
    source_type TEXT,                 -- 'url' | 'text'
    source_content TEXT,              -- Original URL or pasted text
    api_key TEXT NOT NULL UNIQUE,     -- UUID for widget authentication
    message_count INTEGER DEFAULT 0,
    message_limit INTEGER DEFAULT 1000,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Table: `conversations`
```sql
CREATE TABLE conversations (
    id TEXT PRIMARY KEY,              -- UUID
    bot_id TEXT NOT NULL,
    session_id TEXT NOT NULL,         -- Generated by widget, stored in localStorage
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (bot_id) REFERENCES bots(id) ON DELETE CASCADE
);
```

### Table: `messages`
```sql
CREATE TABLE messages (
    id TEXT PRIMARY KEY,              -- UUID
    conversation_id TEXT NOT NULL,
    role TEXT NOT NULL,               -- 'user' | 'assistant'
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE
);
```

### Table: `admin_sessions`
```sql
CREATE TABLE admin_sessions (
    id TEXT PRIMARY KEY,              -- UUID (session token)
    username TEXT NOT NULL,
    token_hash TEXT NOT NULL,         -- SHA-256 hash of session token
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Indexes (for performance)
```sql
CREATE INDEX idx_conversations_bot_id ON conversations(bot_id);
CREATE INDEX idx_conversations_session_id ON conversations(session_id);
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_bots_api_key ON bots(api_key);
```

---

## Project Folder Structure

```
chatbot-oss/
├── backend/
│   ├── main.py                    # FastAPI app entry point
│   ├── database.py                # SQLAlchemy setup, engine, session
│   ├── models.py                  # SQLAlchemy models (Bot, Conversation, Message, AdminSession)
│   ├── schemas.py                 # Pydantic models for request/response validation
│   ├── auth.py                    # Authentication utilities (hash, verify, create session)
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── auth.py               # POST /api/auth/login, /logout
│   │   ├── admin.py              # Admin CRUD: /api/admin/bots, /avatar, etc.
│   │   ├── public.py             # GET /api/public/config/{bot_id}
│   │   └── chat.py               # POST /api/chat (streaming endpoint)
│   ├── services/
│   │   ├── __init__.py
│   │   ├── scraper.py            # Web scraping with crawl4ai/BeautifulSoup
│   │   ├── embeddings.py         # OpenAI embeddings + ChromaDB storage
│   │   └── chat_service.py       # Retrieval + OpenAI chat completion
│   ├── data/                     # Created at runtime
│   │   ├── chatbots.db          # SQLite database
│   │   ├── chroma_data/         # ChromaDB vector store
│   │   └── uploads/
│   │       └── avatars/         # Uploaded bot avatars
│   ├── requirements.txt
│   └── .env.example
│
├── frontend/                      # Dashboard (React app)
│   ├── src/
│   │   ├── main.tsx
│   │   ├── App.tsx
│   │   ├── pages/
│   │   │   ├── Login.tsx
│   │   │   ├── Dashboard.tsx    # Bots list
│   │   │   ├── BotForm.tsx      # Create/Edit bot
│   │   │   ├── TestChat.tsx     # Preview bot
│   │   │   └── Settings.tsx
│   │   ├── components/
│   │   │   ├── BotCard.tsx
│   │   │   ├── AvatarUpload.tsx
│   │   │   ├── ColorPicker.tsx
│   │   │   └── ...
│   │   └── api/
│   │       └── client.ts         # Axios instance for backend calls
│   ├── package.json
│   ├── vite.config.ts
│   └── tailwind.config.js
│
├── widget/                        # Embeddable chat widget
│   ├── src/
│   │   ├── main.tsx              # Entry point
│   │   ├── ChatWidget.tsx        # Main widget component
│   │   ├── components/
│   │   │   ├── ChatBubble.tsx
│   │   │   ├── MessageList.tsx
│   │   │   ├── MessageInput.tsx
│   │   │   └── ...
│   │   └── api/
│   │       └── chat.ts           # API calls to /api/chat
│   ├── package.json
│   └── vite.config.ts            # Library mode: outputs widget.js
│
├── docker-compose.yml
├── Dockerfile
├── .env.example
└── README.md
```

---

## Key Business Rules & Constraints

### Content Ingestion
- **Max scrape size:** 10,000 words per URL
- **Chunk size:** ~500 tokens with 50-token overlap
- **Chunking strategy:** Sentence-aware (don't split mid-sentence)
- **Embedding model:** `text-embedding-3-small` (1536 dimensions)
- **ChromaDB metadata:** `{"bot_id": "...", "chunk_index": 0, "source": "..."}`

### Chat Logic
- **Rate limiting:**
  - Per bot: Check `message_count < message_limit`
  - Per session: Max 10 messages/minute (prevent spam)
- **Context window:** Last 10 messages from conversation history
- **Retrieval:** Top 3 most similar chunks (cosine similarity > 0.7)
- **Streaming:** Use Server-Sent Events (SSE) for real-time responses
- **Model:** `gpt-4o-mini` (fast, cheap)

### File Uploads (Avatars)
- **Allowed formats:** `.png`, `.jpg`, `.jpeg`, `.gif`
- **Max file size:** 500KB
- **Processing:** Resize to 64x64px (center crop, maintain aspect ratio)
- **Storage path:** `./data/uploads/avatars/{bot_id}_{timestamp}.png`
- **Security:** Validate file is actual image (magic numbers), sanitize filename

### Authentication
- **Admin password:** bcrypt hashed (cost factor: 12)
- **Session tokens:** UUID v4, SHA-256 hashed before storage
- **Session expiry:** 7 days
- **Widget API keys:** UUID v4, SHA-256 hashed

---

## Environment Variables (.env)

```bash
# Required
OPENAI_API_KEY=sk-...

# Admin account (first-time setup)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password-here

# Database paths (defaults)
DATABASE_URL=sqlite+aiosqlite:///./data/chatbots.db
CHROMA_PERSIST_DIRECTORY=./data/chroma_data
UPLOAD_PATH=./data/uploads

# Limits
MESSAGE_LIMIT_DEFAULT=1000
MAX_SCRAPE_WORDS=10000
AVATAR_MAX_SIZE_KB=500

# Optional
LOG_LEVEL=INFO
CORS_ORIGINS=*
```

---

## First Steps (Order of Implementation)

### Step 1: Backend Foundation
1. Create FastAPI app (`main.py`)
2. Set up SQLAlchemy models (`models.py`)
3. Initialize database on startup
4. Create basic health check endpoint: `GET /api/health`

### Step 2: Authentication System
1. Implement password hashing utilities (`auth.py`)
2. Create admin user on first run (from env vars)
3. Build login endpoint: `POST /api/auth/login`
4. Session middleware for protected routes

### Step 3: Bot CRUD (Admin Routes)
1. `POST /api/admin/bots` - Create bot
2. `GET /api/admin/bots` - List all bots
3. `GET /api/admin/bots/{id}` - Get single bot
4. `PUT /api/admin/bots/{id}` - Update bot
5. `DELETE /api/admin/bots/{id}` - Delete bot

### Step 4: ChromaDB Integration
1. Initialize ChromaDB client (embedded mode)
2. Create collection per bot (or single collection with metadata filtering)
3. Test embedding + storage with sample text

### Step 5: Ingestion Pipeline
1. Implement web scraper (`services/scraper.py`)
2. Text chunking logic (`services/embeddings.py`)
3. OpenAI embeddings generation
4. Store in ChromaDB
5. Endpoint: `POST /api/admin/bots/{id}/ingest`

### Step 6: Chat Engine
1. Session/conversation management
2. Message storage
3. Retrieval from ChromaDB
4. OpenAI streaming chat
5. Endpoint: `POST /api/chat` (SSE)

### Step 7: Avatar Upload
1. File validation
2. Image processing (resize)
3. Endpoint: `POST /api/admin/bots/{id}/avatar`

### Step 8: Frontend Dashboard
1. React app setup
2. Login page
3. Bots list with cards
4. Create/Edit bot form
5. Live preview

### Step 9: Widget
1. Chat UI components
2. Shadow DOM wrapper
3. API integration
4. Vite library build

### Step 10: Docker + Deployment
1. Dockerfile (multi-stage)
2. docker-compose.yml
3. Production config

---

## Initial Testing Checklist

After backend is ready:
- [ ] Can create admin account on first run
- [ ] Can log in and get session cookie
- [ ] Can create a bot via API
- [ ] Can upload avatar
- [ ] Can scrape a URL (test with simple FAQ page)
- [ ] Can see chunks in ChromaDB
- [ ] Can send a chat message and get response
- [ ] Rate limiting works (reject at limit)
- [ ] Session expires after 7 days

---

## Sample Prompt for AI Assistant

**Phase 1 - Backend Setup:**
```
Using this QUICK-START.md, create a FastAPI project with:
1. SQLAlchemy async models for bots, conversations, messages, admin_sessions
2. Database initialization (create tables on startup)
3. Basic CRUD endpoints for bots (no ChromaDB yet)
4. Session-based authentication for admin routes
5. Health check endpoint

Show me the complete file structure and key files: main.py, models.py, database.py, auth.py
```

**Phase 2 - ChromaDB + Ingestion:**
```
Add the ingestion pipeline:
1. ChromaDB setup (embedded mode)
2. Web scraping service (use crawl4ai, limit 10K words)
3. Text chunking (500 tokens, 50 overlap)
4. OpenAI embeddings generation
5. POST /api/admin/bots/{id}/ingest endpoint

Show me services/scraper.py and services/embeddings.py
```

**Phase 3 - Chat Logic:**
```
Implement the chat endpoint:
1. POST /api/chat with SSE streaming
2. Validate api_key from request body
3. Check message limits
4. Query ChromaDB for top 3 chunks
5. Stream response from OpenAI gpt-4o-mini
6. Save conversation to database

Show me routes/chat.py and services/chat_service.py
```

---

## Common Gotchas

1. **ChromaDB embedded mode:** Requires `chromadb.PersistentClient(path="...")`, not just `Client()`
2. **SQLite + async:** Use `sqlite+aiosqlite://` not `sqlite://`
3. **SSE streaming:** Must set headers: `'Content-Type': 'text/event-stream'`, `'Cache-Control': 'no-cache'`
4. **Widget CORS:** `/api/chat` needs `Access-Control-Allow-Origin: *`
5. **File uploads:** Use `UploadFile` from FastAPI, validate with `python-magic` not just extension
6. **Session security:** Always hash tokens before storage, never store plaintext

---

**This guide is your starting blueprint. Use it to get the foundation running, then move to API-SPEC.md for detailed endpoint implementation.**
